<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MLB Home Run Predictor</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      font-size: 10pt;
      margin: 20px;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
    }
    thead th {
      position: sticky;
      top: 0;
      background: #f0f0f0;
      cursor: pointer;
      border-bottom: 2px solid #ccc;
      padding: 6px 8px;
      user-select: none;
      text-align: left;
    }
    tbody tr {
      border-bottom: 1px solid #ddd;
    }
    tbody tr:last-child {
      border-bottom: none;
    }
    th, td {
      padding: 6px 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      border-left: none !important;
      border-right: none !important;
    }
    .text-left {
      text-align: left;
      padding-left: 12px;
    }
    .text-right {
      text-align: right;
      padding-right: 12px;
      font-feature-settings: "tnum";
    }
  </style>
</head>
<body>

  <h1>MLB Home Run Predictor</h1>
  <p>Data from Baseball Savant + MLB StatsAPI</p>

  <table id="predictor-table" aria-label="MLB Home Run Predictor Table">
    <thead>
      <tr>
        <th data-type="string">Batter Name</th>
        <th data-type="string">Team</th>
        <th data-type="string">Opponent</th>
        <th data-type="string">Opposing Pitcher</th>
        <th data-type="string">Ballpark</th>
        <th data-type="number">Temperature (°F)</th>
        <th data-type="string">Wind</th>
        <th data-type="number">Humidity (%)</th>
        <th data-type="number">Batter HR/PA vs Pitcher Hand</th>
        <th data-type="number">Pitcher HR/PA vs Batter Hand</th>
        <th data-type="number">PA Since Last HR</th>
        <th data-type="number">DraftKings Odds</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="12">Loading data...</td></tr>
    </tbody>
  </table>

<script>
  // Helper function: fetch and parse CSV text into array of objects
  function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',');
    return lines.slice(1).map(line => {
      const values = line.split(',');
      let obj = {};
      headers.forEach((h, i) => {
        obj[h.trim()] = values[i]?.trim();
      });
      return obj;
    });
  }

  // Dummy function to fetch today's MLB games and lineups from statsapi
  async function fetchMLBLineups() {
    const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
    const scheduleUrl = `https://statsapi.mlb.com/api/v1/schedule?sportId=1&date=${today}`;
    const scheduleRes = await fetch(scheduleUrl);
    const scheduleData = await scheduleRes.json();

    // For each game, fetch lineup & game info
    let allLineups = [];
    const games = scheduleData.dates?.[0]?.games || [];
    for (const game of games) {
      const gamePk = game.gamePk;
      const liveFeedUrl = `https://statsapi.mlb.com/api/v1.1/game/${gamePk}/feed/live`;
      const feedRes = await fetch(liveFeedUrl);
      const feedData = await feedRes.json();

      // Get weather and stadium info
      const venue = feedData.gameData?.venue || {};
      const weather = feedData.gameData?.weather || {};
      const homeTeam = feedData.gameData?.teams?.home?.abbreviation || '';
      const awayTeam = feedData.gameData?.teams?.away?.abbreviation || '';

      // Pitchers for each team
      const homePitcher = feedData.liveData?.boxscore?.teams?.home?.pitchers?.[0] || null;
      const awayPitcher = feedData.liveData?.boxscore?.teams?.away?.pitchers?.[0] || null;

      // Lineups by team
      const lineups = feedData.liveData?.boxscore?.teams || {};
      const homeBatters = lineups.home?.batters || [];
      const awayBatters = lineups.away?.batters || [];

      // Map batters to player info
      const playersInfo = feedData.gameData?.players || {};

      // Build lineup array
      homeBatters.forEach(playerId => {
        const player = playersInfo[playerId];
        allLineups.push({
          batterName: player?.fullName,
          batterTeam: homeTeam,
          opponentTeam: awayTeam,
          opposingPitcher: feedData.gameData.players[awayPitcher]?.fullName || '',
          ballpark: venue?.name || '',
          temperature: weather?.temp || null,
          wind: weather?.windSpeed && weather?.windDirection ? `${weather.windSpeed} mph ${weather.windDirection}` : null,
          humidity: weather?.humidity || null,
          batterId: player?.id,
          batterHand: player?.batSide?.code || null,
          pitcherId: awayPitcher,
          pitcherHand: feedData.gameData.players[awayPitcher]?.pitchHand?.code || null,
          // Placeholders for stats:
          batterHRPA: null,
          pitcherHRPA: null,
          paSinceHR: null,
          draftKingsOdds: null
        });
      });
      awayBatters.forEach(playerId => {
        const player = playersInfo[playerId];
        allLineups.push({
          batterName: player?.fullName,
          batterTeam: awayTeam,
          opponentTeam: homeTeam,
          opposingPitcher: feedData.gameData.players[homePitcher]?.fullName || '',
          ballpark: venue?.name || '',
          temperature: weather?.temp || null,
          wind: weather?.windSpeed && weather?.windDirection ? `${weather.windSpeed} mph ${weather.windDirection}` : null,
          humidity: weather?.humidity || null,
          batterId: player?.id,
          batterHand: player?.batSide?.code || null,
          pitcherId: homePitcher,
          pitcherHand: feedData.gameData.players[homePitcher]?.pitchHand?.code || null,
          // Placeholders for stats:
          batterHRPA: null,
          pitcherHRPA: null,
          paSinceHR: null,
          draftKingsOdds: null
        });
      });
    }
    return allLineups;
  }

  // Fetch Baseball Savant data for HR/PA splits (simplified example)
  async function fetchHRPAData() {
    // This is a placeholder URL and minimal example for demo:
    // Real URL and parsing logic will be more complex, likely CSV with filters.
    // We might fetch CSV from Statcast for 2025 season and compute HR/PA by player and pitcher handedness.
    return {}; // Return empty for now
  }

  // Main function to fetch data and fill table
  async function main() {
    const tbody = document.querySelector("#predictor-table tbody");
    tbody.innerHTML = '<tr><td colspan="12">Loading lineups and stats...</td></tr>';

    const lineups = await fetchMLBLineups();
    // Ideally fetch and merge Baseball Savant HR/PA data here
    // const hrpaData = await fetchHRPAData();

    // For demo, just fill the table with lineups and dummy data for HR/PA and odds
    tbody.innerHTML = '';
    lineups.forEach(item => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="text-left">${item.batterName ?? '–'}</td>
        <td class="text-left">${item.batterTeam ?? '–'}</td>
        <td class="text-left">${item.opponentTeam ?? '–'}</td>
        <td class="text-left">${item.opposingPitcher ?? '–'}</td>
        <td class="text-left">${item.ballpark ?? '–'}</td>
        <td class="text-right">${item.temperature ?? '–'}</td>
        <td class="text-left">${item.wind ?? '–'}</td>
        <td class="text-right">${item.humidity ?? '–'}</td>
        <td class="text-right">${(item.batterHRPA !== null ? item.batterHRPA.toFixed(3) : '–')}</td>
        <td class="text-right">${(item.pitcherHRPA !== null ? item.pitcherHRPA.toFixed(3) : '–')}</td>
        <td class="text-right">${(item.paSinceHR !== null ? item.paSinceHR : '–')}</td>
        <td class="text-right">${(item.draftKingsOdds !== null ? item.draftKingsOdds.toFixed(2) : '–')}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  main();
</script>

</body>
</html>
